/*! waveform-data.js - v1.1.0 - 2013-11-28
* Copyright (c) 2013 ; Licensed LGPL-3.0 */
//!function(a){"object"==typeof exports?module.exports=a():"function"==typeof define&&define.amd?define(a):"undefined"!=typeof window?window.WaveformData=a():"undefined"!=typeof global?global.WaveformData=a():"undefined"!=typeof self&&(self.WaveformData=a())}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){"use strict";var c=b.exports=function(a){this.data=a};c.isCompatible=function(a){return a&&"object"==typeof a&&"byteLength"in a},c.fromResponseData=function(a){return new c(new DataView(a))},c.prototype={get version(){return this.data.getInt32(0,!0)},get is_8_bit(){return!!this.data.getUint32(4,!0)},get is_16_bit(){return!this.is_8_bit},get sample_rate(){return this.data.getInt32(8,!0)},get scale(){return this.data.getInt32(12,!0)},get length(){return this.data.getUint32(16,!0)},at:function(a){return Math.round(this.data.getInt8(20+a))}}},{}],2:[function(a,b){"use strict";b.exports={arraybuffer:a("./arraybuffer.js"),object:a("./object.js")}},{"./arraybuffer.js":1,"./object.js":3}],3:[function(a,b){"use strict";var c=b.exports=function(a){this.data=a};c.isCompatible=function(a){return a&&"object"==typeof a&&"sample_rate"in a||"string"==typeof a&&"sample_rate"in JSON.parse(a)},c.fromResponseData=function(a){return"string"==typeof a?new c(JSON.parse(a)):new c(a)},c.prototype={get version(){return this.data.version||1},get is_8_bit(){return 8===this.data.bits},get is_16_bit(){return!this.is_8_bit},get sample_rate(){return this.data.sample_rate},get scale(){return this.data.samples_per_pixel},get length(){return this.data.length},at:function(a){return Math.round(this.data.data[a])}}},{}],4:[function(a,b){"use strict";var c=a("./segment.js"),d=b.exports=function(a,b){this.adapter=b.fromResponseData(a),this.segments={},this.offset(0,this.adapter.length)};d.create=function(a){var b=null,c=null;if(a&&"object"==typeof a&&"response"in a&&(c="responseType"in a?a.response:a.responseText||a.response),Object.keys(d.adapters).some(function(e){return d.adapters[e].isCompatible(c||a)?(b=d.adapters[e],!0):void 0}),null===b)throw new TypeError("Could not detect a WaveformData adapter from the input.");return new d(c||a,b)},d.prototype={offset:function(a,b){var c=this.adapter.length;if(0>b)throw new RangeError("End point must be non-negative.");if(a>=b)throw new RangeError("We can't end prior to the starting point.");if(0>a)throw new RangeError("Start point must be non-negative.");if(a>=c)throw new RangeError("Start point must be within range.");b>c&&(b=c),this.offset_start=a,this.offset_end=b,this.offset_length=b-a},set_segment:function(a,b,d){return d=d||"default",this.segments[d]=new c(this,a,b),this.segments[d]},resample:function(a){"number"==typeof a&&(a={width:a});var b=[],c=a.scale||Math.floor(this.duration*this.adapter.sample_rate/a.width),e=this.adapter.scale,f=a.end_time||this.adapter.length,g=f?this.min_sample(0):0,h=f?this.max_sample(0):0,i=a.start_time||0,j=a.start_time||0,k=-128,l=127;if(e>c)throw new Error("Zoom level "+c+" too low, minimum: "+e);for(var m,n,o,p,q,r=function(a){return Math.floor(a*c)},s=function(a,c){b.push(a,c)};f>i;){for(;Math.floor(r(j)/e)===i;)j&&s(g,h),q=i,j++,m=r(j),n=r(j-1),m!==n&&(g=l,h=k);for(m=r(j),o=Math.floor(m/e),o>f&&(o=f);o>i;)p=this.min_sample(i),g>p&&(g=p),p=this.max_sample(i),p>h&&(h=p),i++}return i!==q&&s(g,h),new d({version:this.adapter.version,samples_per_pixel:c,length:b.length/2,data:b,sample_rate:this.adapter.sample_rate},d.adapters.object)},get min(){return this.offsetValues(this.offset_start,this.offset_length,0)},get max(){return this.offsetValues(this.offset_start,this.offset_length,1)},offsetValues:function(a,b,c){var d=this.adapter,e=Array.apply(null,new Array(b));return c+=2*a,e.map(function(a,b){return d.at(2*b+c)})},get duration(){return this.adapter.length*this.adapter.scale/this.adapter.sample_rate},get offset_duration(){return this.offset_length*this.adapter.scale/this.adapter.sample_rate},get pixels_per_second(){return this.adapter.sample_rate/this.adapter.scale},get seconds_per_pixel(){return this.adapter.scale/this.adapter.sample_rate},at:function(a){return this.adapter.at(a)},at_time:function(a){return Math.floor(a*this.adapter.sample_rate/this.adapter.scale)},time:function(a){return a*this.seconds_per_pixel},in_offset:function(a){return a>=this.offset_start&&a<this.offset_end},min_sample:function(a){return this.adapter.at(2*a)},max_sample:function(a){return this.adapter.at(2*a+1)}},d.adapters={},d.adapter=function(a){this.data=a}},{"./segment.js":5}],5:[function(a,b){"use strict";var c=b.exports=function(a,b,c){this.context=a,this.start=b,this.end=c};c.prototype={get offset_start(){return this.start<this.context.offset_start&&this.end>this.context.offset_start?this.context.offset_start:this.start>=this.context.offset_start&&this.start<this.context.offset_end?this.start:null},get offset_end(){return this.end>this.context.offset_start&&this.end<=this.context.offset_end?this.end:this.end>this.context.offset_end&&this.start<this.context.offset_end?this.context.offset_end:null},get offset_length(){return this.offset_end-this.offset_start},get length(){return this.end-this.start},get visible(){return this.context.in_offset(this.start)||this.context.in_offset(this.end)||this.context.offset_start>this.start&&this.context.offset_start<this.end},get min(){return this.visible?this.context.offsetValues(this.offset_start,this.offset_length,0):[]},get max(){return this.visible?this.context.offsetValues(this.offset_start,this.offset_length,1):[]}}},{}],6:[function(a,b){"use strict";var c=a("./lib/core");c.adapters=a("./lib/adapters"),b.exports=c},{"./lib/adapters":2,"./lib/core":4}]},{},[6])(6)});
!function(e){"object"==typeof exports?module.exports=e():"function"==typeof define&&define.amd?define(e):"undefined"!=typeof window?window.WaveformData=e():"undefined"!=typeof global?global.WaveformData=e():"undefined"!=typeof self&&(self.WaveformData=e())}(function(){var define,module,exports;return(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){"use strict";var WaveformDataArrayBufferAdapter=module.exports=function WaveformDataArrayBufferAdapter(response_data){this.data=response_data;};WaveformDataArrayBufferAdapter.isCompatible=function isCompatible(data){return data&&typeof data==="object"&&"byteLength"in data;};WaveformDataArrayBufferAdapter.fromResponseData=function fromArrayBufferResponseData(response_data){return new WaveformDataArrayBufferAdapter(new DataView(response_data));};WaveformDataArrayBufferAdapter.prototype={get version(){return this.data.getInt32(0,true);},get is_8_bit(){return!!this.data.getUint32(4,true);},get is_16_bit(){return!this.is_8_bit;},get sample_rate(){return this.data.getInt32(8,true);},get scale(){return this.data.getInt32(12,true);},get length(){return this.data.getUint32(16,true);},at:function at_sample(index){return Math.round(this.data.getInt8(20+index));}};},{}],2:[function(require,module,exports){"use strict";module.exports={"arraybuffer":require("./arraybuffer.js"),"object":require("./object.js")};},{"./arraybuffer.js":1,"./object.js":3}],3:[function(require,module,exports){"use strict";var WaveformDataObjectAdapter=module.exports=function WaveformDataObjectAdapter(response_data){this.data=response_data;};WaveformDataObjectAdapter.isCompatible=function isCompatible(data){return data&&(typeof data==="object"&&"sample_rate"in data)||(typeof data==="string"&&"sample_rate"in JSON.parse(data));};WaveformDataObjectAdapter.fromResponseData=function fromJSONResponseData(response_data){if(typeof response_data==="string"){return new WaveformDataObjectAdapter(JSON.parse(response_data));}
else{return new WaveformDataObjectAdapter(response_data);}};WaveformDataObjectAdapter.prototype={get version(){return this.data.version||1;},get is_8_bit(){return this.data.bits===8;},get is_16_bit(){return!this.is_8_bit;},get sample_rate(){return this.data.sample_rate;},get scale(){return this.data.samples_per_pixel;},get length(){return this.data.length;},at:function at_sample(index){return Math.round(this.data.data[index]);}};},{}],4:[function(require,module,exports){"use strict";var WaveformDataSegment=require("./segment.js");var WaveformData=module.exports=function WaveformData(response_data,adapter){this.adapter=adapter.fromResponseData(response_data);this.segments={};this.offset(0,this.adapter.length);};WaveformData.create=function createFromResponseData(data){var adapter=null;var xhrData=null;if(data&&typeof data==="object"&&"response"in data){xhrData=("responseType"in data)?data.response:(data.responseText||data.response);}
Object.keys(WaveformData.adapters).some(function(adapter_id){if(WaveformData.adapters[adapter_id].isCompatible(xhrData||data)){adapter=WaveformData.adapters[adapter_id];return true;}});if(adapter===null){throw new TypeError("Could not detect a WaveformData adapter from the input.");}
return new WaveformData(xhrData||data,adapter);};WaveformData.prototype={offset:function(start,end){var data_length=this.adapter.length;if(end<0){throw new RangeError("End point must be non-negative.");}
if(end<=start){throw new RangeError("We can't end prior to the starting point.");}
if(start<0){throw new RangeError("Start point must be non-negative.");}
if(start>=data_length){throw new RangeError("Start point must be within range.");}
if(end>data_length){end=data_length;}
this.offset_start=start;this.offset_end=end;this.offset_length=end-start;},set_segment:function setSegment(start,end,identifier){identifier=identifier||"default";this.segments[identifier]=new WaveformDataSegment(this,start,end);return this.segments[identifier];},resample:function(options){if(typeof options==='number'){options={width:options};}
var output_data=[];var samples_per_pixel=options.scale||Math.floor(this.duration*this.adapter.sample_rate/options.width);var scale=this.adapter.scale;var start_sample_input_index=0;var start_sample_output_index=0;if(options.start_time){start_sample_input_index=Math.floor(options.start_time*this.adapter.sample_rate/this.adapter.scale);start_sample_output_index=Math.floor(options.start_time*this.adapter.sample_rate/samples_per_pixel);}
var input_buffer_size=this.adapter.length;var input_index=options.input_index||0;var output_index=options.output_index||0;var min=input_buffer_size?this.min_sample(input_index):0;var max=input_buffer_size?this.max_sample(input_index):0;var min_value=-128;var max_value=127;if(samples_per_pixel<scale){throw new Error("Zoom level "+samples_per_pixel+" too low, minimum: "+scale);}
var where,prev_where,stop,value,last_input_index;var sample_at_pixel=function sample_at_pixel(x){return Math.floor(x*samples_per_pixel);};var add_sample=function add_sample(min,max){output_data.push(min,max);};while(input_index<input_buffer_size){while(Math.floor(sample_at_pixel(output_index)/scale)<=input_index){if(output_index){add_sample(min,max);}
last_input_index=input_index;output_index++;where=sample_at_pixel(output_index);prev_where=sample_at_pixel(output_index-1);if(where!==prev_where){min=max_value;max=min_value;}}
where=sample_at_pixel(output_index);stop=Math.floor(where/scale);if(stop>input_buffer_size){stop=input_buffer_size;}
while(input_index<stop){value=this.min_sample(input_index);if(value<min){min=value;}
value=this.max_sample(input_index);if(value>max){max=value;}
input_index++;}
if(options.length){if((output_data.length/2)>=options.length){break;}}}
if(options.length){if((output_data.length/2)>options.length){if(input_index!==last_input_index){add_sample(min,max);}}}else{if(input_index!==last_input_index){add_sample(min,max);}}
return new WaveformData({version:this.adapter.version,samples_per_pixel:samples_per_pixel,length:output_data.length/2,data:output_data,sample_rate:this.adapter.sample_rate},WaveformData.adapters.object);},get min(){return this.offsetValues(this.offset_start,this.offset_length,0);},get max(){return this.offsetValues(this.offset_start,this.offset_length,1);},offsetValues:function getOffsetValues(start,length,correction){var adapter=this.adapter;var values=Array.apply(null,new Array(length));correction+=(start*2);return values.map(function offsetValueMapper(val,i){return adapter.at((i*2)+correction);});},get duration(){return(this.adapter.length*this.adapter.scale)/this.adapter.sample_rate;},get offset_duration(){return(this.offset_length*this.adapter.scale)/this.adapter.sample_rate;},get pixels_per_second(){return this.adapter.sample_rate/this.adapter.scale;},get seconds_per_pixel(){return this.adapter.scale/this.adapter.sample_rate;},at:function at_sample_proxy(index){return this.adapter.at(index);},at_time:function at_time(time){return Math.floor((time*this.adapter.sample_rate)/this.adapter.scale);},time:function time(index){return index*this.seconds_per_pixel;},in_offset:function isInOffset(pixel){return pixel>=this.offset_start&&pixel<this.offset_end;},min_sample:function getMinValue(offset){return this.adapter.at(offset*2);},max_sample:function getMaxValue(offset){return this.adapter.at((offset*2)+1);}};WaveformData.adapters={};WaveformData.adapter=function WaveformDataAdapter(response_data){this.data=response_data;};},{"./segment.js":5}],5:[function(require,module,exports){"use strict";var WaveformDataSegment=module.exports=function WaveformDataSegment(context,start,end){this.context=context;this.start=start;this.end=end;};WaveformDataSegment.prototype={get offset_start(){if(this.start<this.context.offset_start&&this.end>this.context.offset_start){return this.context.offset_start;}
if(this.start>=this.context.offset_start&&this.start<this.context.offset_end){return this.start;}
return null;},get offset_end(){if(this.end>this.context.offset_start&&this.end<=this.context.offset_end){return this.end;}
if(this.end>this.context.offset_end&&this.start<this.context.offset_end){return this.context.offset_end;}
return null;},get offset_length(){return this.offset_end-this.offset_start;},get length(){return this.end-this.start;},get visible(){return this.context.in_offset(this.start)||this.context.in_offset(this.end)||(this.context.offset_start>this.start&&this.context.offset_start<this.end);},get min(){return this.visible?this.context.offsetValues(this.offset_start,this.offset_length,0):[];},get max(){return this.visible?this.context.offsetValues(this.offset_start,this.offset_length,1):[];}};},{}],6:[function(require,module,exports){"use strict";var WaveformData=require("./lib/core");WaveformData.adapters=require("./lib/adapters");module.exports=WaveformData;},{"./lib/adapters":2,"./lib/core":4}]},{},[6])
(6)});;